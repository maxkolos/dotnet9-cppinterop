name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up .NET 9
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x

      # - name: Install Playwright
      #   run: |
      #     cd src/tests/BrowserTests
      #     npm ci
      #     if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
      #       CI=true npx playwright install --with-deps
      #     else
      #       npx playwright install
      #     fi
      #   shell: bash
      - name: Install Playwright browsers
        run: |
          cd src/tests/BrowserTests
          npm ci
          npx playwright install
        env:
          CI: 1

      - name: Build all projects
        run: make build

      - name: Run tests
        run: |
          make test-multios
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            make test-browser
          else
            # Browser tests (PowerShell instead of kill)
            pwsh -c '
              Start-Job { dotnet run --project src/web-ui/web-ui.csproj } | Out-Null;
              Start-Sleep -Seconds 5;
              cd src/tests/BrowserTests;
              npm test
            '
          fi
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            make test-docker
          fi
        shell: bash

      - name: Build Docker image
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
               make docker-build
          fi
          
